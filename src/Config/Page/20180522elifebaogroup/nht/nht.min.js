var env;
if (checkEnv("uatapi2") > 0) {
	env = "https://uatapi2.renrenbx.com";
} else if (checkEnv("api2") > 0) {
	env = "//api2.renrenbx.com";
} else if (checkEnv("localhost:7010") > 0) {
	env = "//localhost:7010";
} else if (checkEnv("localhost:8080") > 0) {
	//env = "//192.168.1.254:8080";
	env = "https://uatapi2.renrenbx.com";
};

function checkEnv(par) {
	return window.location.origin.indexOf(par);
}

var rrbx = JSON.parse(localStorage.getItem("20180522elifebaogroup"));

// 加载js
function loadScript(url, callback) {
	var script = document.createElement("script")
	script.type = "text/javascript";
	if (script.readyState) {
		script.onreadystatechange = function() {
			if (script.readyState == "loaded" || script.readyState == "complete") {
				script.onreadystatechange = null;
				callback();
			}
		};
	} else {
		script.onload = function() {
			callback();
		};
	}
	script.src = url;
	document.getElementsByTagName("head")[0].appendChild(script);
}

// 弹出框
function noneAlert(callback) {
	var tpl = '<div class="modal-bg">' +
		'<div class="modal">' +
		'<div class="modal-show" id="sign_show"></div>' +
		'<div class="modal-title">请用楷体字签字确认</div>' +
		'<canvas class="modal-canvas" id="canvasEdit"></canvas>' +
		'<div class="modal-buttons">' +
		'<div id="sign_clear" class="buttons-cancel">取消</div>' +
		'<div id="sign_ok" class="buttons-sure">确认</div>' +
		'</div>' +
		'<div class="modal-text">注：为子女投保（18周岁以下未成年人），由监护人负责签字。<div>' +
		'</div>' +
		'</div>';
	$("body").append(tpl);

	$("#sign_clear").bind("click", function(event) {
		/* Act on the event */
		$(".modal-bg").remove();
	});

	$("#sign_ok").on("click", function(event) {
		event.preventDefault();
		/* Act on the event */
		setTimeout(function() {
			var imgData = $("#sign_show > img").attr("src");

			if (imgData && imgData.split("").length > 1594) {
				$.ajax({
					type: "POST",
					url: env + "/mobile/upload/sign",
					data: {
						"sign": imgData
					},
					beforeSend: function() {},
					success: function(data) {
						if (data.code == 10000) {
							rrbx.insuredPars.pars.rrbx.extraParams.sign = data.response;
							localStorage.setItem("20180522elifebaogroup", JSON.stringify(rrbx));
							if (Object.is(GV.sceneType, "3")) {
								window.location.href = GV.appHref;
							} else {
								window.location.href = GV.h5Href;
							};
						} else {
							hasAlert(data.info, function() {})
						};
					},
					error: function(xhr, type) {
						hasAlert(xhr, function() {})
					},
					complete: function(xhr, status) {}
				})
			} else {
				hasAlert("请输入正确的签名!", function() {})
			};
		}, 300)
	});

	if (callback) {
		callback()
	};
}

function hasAlert(content, callback) {
	var tpl = '<div class="bmodal-bg">' +
		'<div class="bmodal">' +
		'<div class="bmodal-tip">' + content + '<div>' +
		'</div>' +
		'</div>';
	$("body").append(tpl);

	$(".bmodal-bg").bind("click", function(event) {
		/* Act on the event */
		$(this).remove();
	});
	if (callback) {
		callback()
	};
}

function telAlert(content, callback) {
	var tpl = '<div class="tmodal-bg">' +
		'<div class="tmodal">' +
		'<a class="tmodal-tip" href="tel:13621979955">' + content + '<div>' +
		'</div>' +
		'</div>';
	$("body").append(tpl);

	$(".tmodal-bg").bind("click", function(event) {
		/* Act on the event */
		$(this).remove();
	});
	if (callback) {
		callback()
	};
}

loadScript('https://m1.renrenbx.com/rrbxcdn/rrbx/elifebaogroup/signature.js', function() {});

$(".ht-footer").on('click', 'a', function(event) {
	event.preventDefault();
	/* Act on the event */
	var textTag = $(this).text();

	if (Object.is(textTag, "以上情况全无")) {
		noneAlert(function() {
			//初始化动作，根据DOM的ID不同进行自定义，如果不写则内部默认取这四个
			$().esign("canvasEdit", "sign_show", "sign_clear", "sign_ok");
		})
	} else {
		telAlert("部分情况有：可联系客服：13621979955，进行单独核保", function() {})
	};
});